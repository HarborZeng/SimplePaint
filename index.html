<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Harbor Paint</title>
    <link rel="stylesheet" href="css/paint-style.css"/>
</head>
<body>
<div class="container">
    <nav class="banner">

        <a class="paint-title" href="index.html">Harbor画板</a>

        <div class="function-bar">
            <ul class="function-list">
                <li class="paint-function" id="open-action" onclick="openSelected()">打开</li>
                <li class="paint-function" id="save-action" onclick="saveSelected()">保存</li>
                <li class="paint-function">
                    <span>画笔形状</span>
                    <ul class="submenu-list" onclick="shapeSelected()">
                        <li class="paint-function submenu-item" id="curve-shape">曲线</li>
                        <li class="paint-function submenu-item" id="line-shape">直线</li>
                        <li class="paint-function submenu-item" id="circle-shape">圆</li>
                        <li class="paint-function submenu-item" id="oval-shape">椭圆</li>
                        <li class="paint-function submenu-item" id="rectangle-shape">矩形</li>
                    </ul>
                </li>
                <li class="paint-function">
                    <span>画笔粗细</span>
                    <ul class="submenu-list" onclick="penTypeSelected()">
                        <li class="paint-function submenu-item" id="very_thin-pen">很细</li>
                        <li class="paint-function submenu-item" id="thin-pen">细</li>
                        <li class="paint-function submenu-item" id="normal-pen">普通</li>
                        <li class="paint-function submenu-item" id="bold-pen">粗</li>
                        <li class="paint-function submenu-item" id="very_bold-pen">很粗</li>
                    </ul>
                </li>
                <li class="paint-function">
                    <span>画笔颜色</span>
                    <ul class="submenu-list" onclick="penColorSelected()">
                        <li class="paint-function submenu-item" id="blue-pen_color">蓝色</li>
                        <li class="paint-function submenu-item" id="black-pen_color">黑色</li>
                        <li class="paint-function submenu-item" id="purple-pen_color">紫色</li>
                        <li class="paint-function submenu-item" id="red-pen_color">红色</li>
                        <li class="paint-function submenu-item" id="green-pen_color">绿色</li>
                        <li class="paint-function submenu-item" id="yellow-pen_color">黄色</li>
                        <li class="paint-function submenu-item" id="white-pen_color">白色</li>
                        <li class="paint-function submenu-item" id="brown-pen_color">棕色</li>
                        <li class="paint-function submenu-item" id="pink-pen_color">粉色</li>
                        <li class="paint-function submenu-item" id="grey-pen_color">灰色</li>
                        <li class="paint-function submenu-item" id="customized-pen_color">自定义</li>
                    </ul>
                </li>
                <li class="paint-function">
                    <span>橡皮镲</span>
                    <ul class="submenu-list" onclick="eraserSelected()">
                        <li class="paint-function submenu-item" id="small-eraser">小号</li>
                        <li class="paint-function submenu-item" id="normal-eraser">普通</li>
                        <li class="paint-function submenu-item" id="large-eraser">大号</li>
                        <li class="paint-function submenu-item" id="very_large-eraser">极大</li>
                    </ul>
                </li>
                <li class="paint-function" id="undo-action" onclick="erase()">undo</li>
            </ul>
        </div>

    </nav>
    <canvas id="myCanvas">Sorry, your browser doesn't support the &lt;canvas&gt;element.</canvas>
    <div>
        <pre>
            画图板：面向对象编程，只提交代码，截止时间11月30日
            1、曲线、直线、圆/椭圆、矩形
            2、画笔粗细、颜色
            3、橡皮擦，擦除形状
            4、矢量图保存、打开
        </pre>
    </div>
    <script>
        var myCanvas = (function () {
            return document.getElementById('myCanvas');
        })();
        /**
         * 原地调用初始化canvas和context对象
         * @return context canvas的context对象
         */
        var context = (function () {
            myCanvas.width = window.innerWidth - 80;
            myCanvas.height = window.innerHeight - 50;
            return myCanvas.getContext('2d');
        })();


        //↓↓↓↓↓↓↓↓↓↓Menu父类定义begins↓↓↓↓↓↓↓↓↓↓
        /**
         * 菜单对象的父类
         * @constructor 空
         */
        function Menu() {
        }

        /**
         * 给菜单对象添加原形name
         * @type {string} name的值
         */
        Menu.prototype.name = 'menu';
        /**
         * 给菜单对象添加原形items
         * @type {{default_item: string}}
         * 是一个列表对象，代表
         */
        Menu.prototype.items = {
            default_item: ''
        };
        Menu.prototype.getCurrent = function () {
            return this.items.default_item;
        };
        Menu.prototype.setCurrent = function (selection) {
            this.items.default_item = selection;
        };
        Menu.prototype.getItems = function () {
            return this.items;
        };
        Menu.prototype.menuItemSelected = function (selection) {
            this.setCurrent(selection);
        };
        Menu.prototype.toString = function () {
            return this.name + ' has ' + this.items;
        };

        //↑↑↑↑↑↑↑↑↑↑↑↑Menu父类定义ends↑↑↑↑↑↑↑↑↑↑↑↑


        /**
         * extend函数用来模拟继承，解决子对象和父对象指向同一个对象，
         * 子对象修改原型，父对象也会被修改的不足之处
         * @param Child 子类
         * @param Parent 父类
         */
        function extend(Child, Parent) {
            var F = function () {
            };
            F.prototype = Parent.prototype;
            Child.prototype = new F();
            Child.prototype.constructor = Child;
            Child.uber = Parent.prototype;
        }

        //↓↓↓↓↓↓↓↓↓↓ShapeMenu子类定义begins↓↓↓↓↓↓↓↓↓↓
        function ShapeMenu() {
        }

        extend(ShapeMenu, Menu);

        ShapeMenu.prototype.name = 'shape menu';
        ShapeMenu.prototype.items = {
            curve: 'curve-shape',
            line: 'line-shape',
            circle: 'circle-shape',
            oval: 'oval-shape',
            rectangle: 'rectangle-shape',
            default_item: 'curve-shape'
        };
        //↑↑↑↑↑↑↑↑↑↑↑↑ShapeMenu子类定义ends↑↑↑↑↑↑↑↑↑↑↑↑

        //↓↓↓↓↓↓↓↓↓↓PenType子类定义begins↓↓↓↓↓↓↓↓↓↓
        function PenTypeMenu() {
        }

        extend(PenTypeMenu, Menu);

        PenTypeMenu.prototype.name = 'Pen Type Menu';
        PenTypeMenu.prototype.items = {
            veryThin: 'very_thin-pen',
            thin: 'thin-pen',
            normal: 'normal-pen',
            bold: 'bold-pen',
            veryBold: 'very_bold-pen',
            default_item: 'normal-pen'
        };
        //↑↑↑↑↑↑↑↑↑↑↑↑PenTypeMenu子类定义ends↑↑↑↑↑↑↑↑↑↑↑↑

        //↓↓↓↓↓↓PenColor子类定义begins↓↓↓↓↓↓
        function PenColorMenu() {
        }

        extend(PenColorMenu, Menu);

        PenColorMenu.prototype.name = 'Pen color Menu';
        PenColorMenu.prototype.items = {
            blue: 'blue-pen_color',
            black: 'black-pen_color',
            purple: 'purple-pen_color',
            red: 'red-pen_color',
            green: 'green-pen_color',
            yellow: 'yellow-pen_color',
            white: 'white-pen_color',
            brown: 'brown-pen_color',
            pink: 'pink-pen_color',
            grey: 'grey-pen_color',
            customized: 'customized-pen_color',
            default_item: 'black-pen_color'
        };
        //↑↑↑↑↑↑↑PenColorMenu子类定义ends↑↑↑↑↑↑↑

        //↓↓↓↓↓↓EraserMenu子类定义begins↓↓↓↓↓↓
        function EraserMenu() {
        }

        extend(EraserMenu, Menu);

        EraserMenu.prototype.name = 'Eraser Menu';
        EraserMenu.prototype.items = {
            small: 'small-eraser',
            normal: 'normal-eraser',
            large: 'large-eraser',
            veryLarge: 'very_large-eraser',
            default_item: 'normal-eraser'
        };
        //↑↑↑↑↑↑↑↑EraserMenu子类定义ends↑↑↑↑↑↑↑↑

        //↓↓↓↓↓↓点击事件类定义begins↓↓↓↓↓↓
        function openSelected() {

        }

        function saveSelected() {

        }

        function shapeSelected() {
            var shapeID = event.target.id;
            shapeMenu = new ShapeMenu();
            shapeMenu.menuItemSelected(shapeID);
            menuSelected(shapeMenu);
        }

        function penTypeSelected() {
            var penTypeID = event.target.id;
            penTypeMenu = new PenTypeMenu();
            penTypeMenu.menuItemSelected(penTypeID);
            menuSelected(penTypeMenu);
        }

        function penColorSelected() {
            var penColorID = event.target.id;
            penColorMenu = new PenColorMenu();
            penColorMenu.menuItemSelected(penColorID);
            menuSelected(penColorMenu);
        }

        function eraserSelected() {
            var eraserID = event.target.id;
            eraserMenu = new EraserMenu();
            eraserMenu.menuItemSelected(eraserID);
            menuSelected(eraserMenu);
        }

        //↑↑↑↑↑↑↑↑↑点击事件类定义ends↑↑↑↑↑↑↑↑↑


        function menuSelected(menu) {
            var items = menu.getItems();
            var keys = Object.keys(items);
            clearPreviousSelection(keys, items);

            var selectedID = menu.getCurrent();
            var selection = document.getElementById(selectedID);
            selection.style.color = '#548248';
            selection.style.background = '#333';
            selection.style.fontWeight = 'bold';
        }

        function clearPreviousSelection(keys, items) {
            for (var i = 0; i < keys.length; i++) {
                var id = document.getElementById(items[keys[i]]);
                id.style.color = '#b7b7b7';
                id.style.background = '#222';
                id.style.fontWeight = 'normal';
            }
        }

        var shapeMenu;
        var penTypeMenu;
        var penColorMenu;
        var eraserMenu;

        /**
         * 初始化菜单的默认选择
         */
        (function initSelection() {
            shapeMenu = new ShapeMenu();
            menuSelected(shapeMenu);
            penTypeMenu = new PenTypeMenu();
            menuSelected(penTypeMenu);
            penColorMenu = new PenColorMenu();
            menuSelected(penColorMenu);
            eraserMenu = new EraserMenu();
            menuSelected(eraserMenu);
            context.imageSmoothingEnabled = true;
            context.mozImageSmoothingEnabled = true;
            context.webkitImageSmoothingEnabled = true;
            context.msImageSmoothingEnabled = true;
        })();

        function Shape(originalX, originalY, nowX, nowY, penWidth, penColor, name) {
            this.originalX = originalX;
            this.originalY = originalY;
            this.nowX = nowX;
            this.nowY = nowY;
            this.penWidth = penWidth;
            this.penColor = penColor;
            this.shape = name;
        }

        //↑↑↑↑↑↑↑↑↑↑↑↑Shape父类定义ends↑↑↑↑↑↑↑↑↑↑↑↑

        function Line(originalX, originalY, nowX, nowY, penWidth, penColor, name) {
            Shape.call(this, originalX, originalY, nowX, nowY, penWidth, penColor, name);
        }

        extend(Line, Shape);

        Line.prototype.draw = function () {
            context.save();
            context.beginPath();
            context.lineWidth = this.penWidth;
            context.strokeStyle = this.penColor;
            context.moveTo(this.originalX, this.originalY);
            context.lineTo(this.nowX, this.nowY);
            context.stroke();
            context.closePath();
            context.restore();
        };

        function Rectangle(originalX, originalY, nowX, nowY, penWidth, penColor, name) {
            Shape.call(this, originalX, originalY, nowX, nowY, penWidth, penColor, name);
        }

        extend(Rectangle, Shape);
        Rectangle.prototype.draw = function () {
            context.lineWidth = this.penWidth;
            context.strokeStyle = this.penColor;
            context.strokeRect(this.originalX, this.originalY,
                this.nowX - this.originalX, this.nowY - this.originalY);
        };

        function Circle(originalX, originalY, nowX, nowY, penWidth, penColor, name) {
            Shape.call(this, originalX, originalY, nowX, nowY, penWidth, penColor, name);
        }

        extend(Circle, Shape);
        Circle.prototype.draw = function () {
            context.lineWidth = this.penWidth;
            context.strokeStyle = this.penColor;

            var radius = Math.sqrt(
                Math.pow(Math.abs(this.nowX - this.originalX) / 2, 2)
                + Math.pow(Math.abs(this.nowY - this.originalY) / 2, 2)
            );
            var centerX = this.originalX
                + (this.nowX - this.originalX) / 2;
            var centerY = this.originalY
                + (this.nowY - this.originalY) / 2;

            context.beginPath();
            context.arc(centerX, centerY, radius, 0, Math.PI * 2, true);
            context.stroke();
            context.closePath();
        };

        function Curve(originalX, originalY, nowX, nowY, penWidth, penColor, name) {
            Shape.call(this, originalX, originalY, nowX, nowY, penWidth, penColor, name);
        }

        extend(Curve, Shape);
        Curve.prototype.draw = function () {
            context.lineWidth = this.penWidth;
            context.strokeStyle = this.penColor;
            context.lineTo(this.nowX, this.nowY);
            context.stroke();
        };

        function Oval(originalX, originalY, nowX, nowY, penWidth, penColor, name) {
            Shape.call(this, originalX, originalY, nowX, nowY, penWidth, penColor, name);
        }

        extend(Oval, Shape);
        Oval.prototype.draw = function () {
            context.lineWidth = this.penWidth;
            context.strokeStyle = this.penColor;

            var centerX = this.originalX;
            var centerY = this.originalY;
            var height = this.nowY - this.originalY;
            var width = this.nowX - this.originalX;

            context.beginPath();
            context.moveTo(centerX, centerY - height / 2);

            context.bezierCurveTo(
                centerX + width / 2, centerY - height / 2,
                centerX + width / 2, centerY + height / 2,
                centerX, centerY + height / 2
            );
            context.bezierCurveTo(
                centerX - width / 2, centerY + height / 2,
                centerX - width / 2, centerY - height / 2,
                centerX, centerY - height / 2
            );

            context.stroke();
            context.closePath();
        };

        var mouse = {
            originalX: innerWidth / 2,
            originalY: innerHeight / 2,
            nowX: innerHeight / 2,
            nowY: innerHeight / 2,
            mouseStatus: 'not_defined',
            mouseStatusList: {
                down: 'down',
                up: 'up',
                notDefined: 'not_defined'
            },
            setMouseStatusDown: function () {
                this.mouseStatus = this.mouseStatusList.down;
            },
            setMouseStatusUp: function () {
                this.mouseStatus = this.mouseStatusList.up;
            },
            getMouseStatus: function () {
                return this.mouseStatus;
            }
        };

        var imageData;
        var imageStack = [];

        function erase() {
            imageStack.pop();
            context.clearRect(0, 0, myCanvas.width, myCanvas.height);
            for (var i = 0; i < imageStack.length; i++) {
                context.putImageData(imageStack[i], 0, 0);
            }
            console.log(imageStack);
        }

        function myCanvasMouseDown(event) {
            console.log('mouse down');
            if (event.button === 0) {
                mouse.originalX = event.offsetX;
                mouse.nowX = event.offsetX;
                mouse.originalY = event.offsetY;
                mouse.nowY = event.offsetY;
                imageData = context
                    .getImageData(0, 0, myCanvas.width, myCanvas.height);
                mouse.setMouseStatusDown();
            }
            switch (shapeMenu.getCurrent()) {
                case shapeMenu.items.circle:
                    //do nothing
                    break;
                case shapeMenu.items.rectangle:
                    //do nothing
                    break;
                case shapeMenu.items.line:
                    //do nothing
                    break;
                case shapeMenu.items.oval:
                    //do nothing
                    break;
                case shapeMenu.items.curve:
                    context.beginPath();
                    context.moveTo(mouse.nowX, mouse.nowY);
                    break;
                default:
                    console.warn('In myCanvasMouseDown, went to default!!!');
            }
        }

        function drawShape(event) {
            context.clearRect(0, 0, myCanvas.width, myCanvas.height);
            for (var i = 0; i < imageStack.length; i++) {
                context.putImageData(imageStack[i], 0, 0);
            }

            mouse.nowX = event.offsetX;
            mouse.nowY = event.offsetY;

            var lineColor = '#fff';
            if (penColorMenu.getCurrent() === penColorMenu.items.customized) {
                //TODO
            } else {
                lineColor = penColorMenu.getCurrent()
                    .substring(0, penColorMenu.getCurrent().indexOf('-'));
            }

            var lineWidth = 0;
            switch (penTypeMenu.getCurrent()) {
                case penTypeMenu.items.bold:
                    lineWidth = 15;
                    break;
                case penTypeMenu.items.veryBold:
                    lineWidth = 20;
                    break;
                case penTypeMenu.items.normal:
                    lineWidth = 10;
                    break;
                case penTypeMenu.items.veryThin:
                    lineWidth = 1;
                    break;
                case penTypeMenu.items.thin:
                    lineWidth = 5;
                    break;
                default:
                    console.warn('In myCanvasMouseMove choose pen type' +
                        ', went to default!!!');
            }

            switch (shapeMenu.getCurrent()) {
                case shapeMenu.items.circle:
                    var circle = new Circle(mouse.originalX, mouse.originalY,
                        mouse.nowX, mouse.nowY,
                        lineWidth, lineColor, 'circle');
                    circle.draw();
                    break;
                case shapeMenu.items.rectangle:
                    var rectangle = new Rectangle(mouse.originalX, mouse.originalY,
                        mouse.nowX, mouse.nowY,
                        lineWidth, lineColor, 'rectangle');
                    rectangle.draw();
                    break;
                case shapeMenu.items.line:
                    var line = new Line(mouse.originalX, mouse.originalY,
                        mouse.nowX, mouse.nowY,
                        lineWidth, lineColor, 'line');
                    line.draw();
                    break;
                case shapeMenu.items.curve:
                    var curve = new Curve(mouse.originalX, mouse.originalY,
                        mouse.nowX, mouse.nowY,
                        lineWidth, lineColor, 'curve');
                    curve.draw();
                    break;
                case shapeMenu.items.oval:
                    var oval = new Oval(mouse.originalX, mouse.originalY,
                        mouse.nowX, mouse.nowY,
                        lineWidth, lineColor, 'oval');
                    oval.draw();
                    break;
                default:
                    console.warn('In myCanvasMouseMove, went to default!!!');
            }
        }

        function myCanvasMouseMove(event) {
            if (mouse.getMouseStatus() === mouse.mouseStatusList.down) {
                console.log('mouse moving on down condition');
                drawShape(event);
            }
        }

        function myCanvasMouseUp(event) {
            console.log('mouse up');
            if (mouse.getMouseStatus() === mouse.mouseStatusList.down) {
                drawShape(event);

                imageData = context
                    .getImageData(0, 0, myCanvas.width, myCanvas.height);
                imageStack.push(imageData);

                mouse.setMouseStatusUp();
                mouse.nowX = null;
                mouse.nowY = null;
            }
        }

        myCanvas.addEventListener('mousedown', myCanvasMouseDown);
        myCanvas.addEventListener('mouseup', myCanvasMouseUp);
        myCanvas.addEventListener('mousemove', myCanvasMouseMove);
    </script>
</div>
</body>
</html>